<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>In Search of an Understandable Consensus Algorithm(Extended Version) | Mr言的博客</title><meta name="description" content="abstract raft是一个管理分布日志的一致性算法，运行结果和Paxos一致，但是结构并不一样，因此Raft比Paxos更易懂，也为构建系统提供了更好的基础。为了更好理解，Raft将一致性的关键点分开，比如领导选取，日志备份，安全性。通过减少了状态数量加强了一致性的强度。  Introduction Raft的目的是可理解性。因此将关键元素进行解偶。相关特性  Strong leader："><meta name="keywords" content="分布式系统,文件系统"><meta name="author" content="严轶轩"><meta name="copyright" content="严轶轩"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://hm.baidu.com"/><link rel="dns-prefetch" href="https://hm.baidu.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="KMNZCFXyxopGAiX0"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="In Search of an Understandable Consensus Algorithm(Extended Version)"><meta name="twitter:description" content="abstract raft是一个管理分布日志的一致性算法，运行结果和Paxos一致，但是结构并不一样，因此Raft比Paxos更易懂，也为构建系统提供了更好的基础。为了更好理解，Raft将一致性的关键点分开，比如领导选取，日志备份，安全性。通过减少了状态数量加强了一致性的强度。  Introduction Raft的目的是可理解性。因此将关键元素进行解偶。相关特性  Strong leader："><meta name="twitter:image" content="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/dZ4ECE.jpg"><meta property="og:type" content="article"><meta property="og:title" content="In Search of an Understandable Consensus Algorithm(Extended Version)"><meta property="og:url" content="https://www.mryan.cool/2021/09/02/In-Search-of-an-Understandable-Consensus-Algorithm-Extended-Version/"><meta property="og:site_name" content="Mr言的博客"><meta property="og:description" content="abstract raft是一个管理分布日志的一致性算法，运行结果和Paxos一致，但是结构并不一样，因此Raft比Paxos更易懂，也为构建系统提供了更好的基础。为了更好理解，Raft将一致性的关键点分开，比如领导选取，日志备份，安全性。通过减少了状态数量加强了一致性的强度。  Introduction Raft的目的是可理解性。因此将关键元素进行解偶。相关特性  Strong leader："><meta property="og:image" content="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/dZ4ECE.jpg"><meta property="article:published_time" content="2021-09-02T08:09:24.000Z"><meta property="article:modified_time" content="2021-11-04T01:45:14.432Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://www.mryan.cool/2021/09/02/In-Search-of-an-Understandable-Consensus-Algorithm-Extended-Version/"><link rel="prev" title="python依赖树--pipdeptree" href="https://www.mryan.cool/2021/10/14/python%E4%BE%9D%E8%B5%96%E6%A0%91-pipdeptree/"><link rel="next" title="The Google File System" href="https://www.mryan.cool/2021/08/18/The-Google-File-System/"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c11dcf5678886a7b82be8df8aa725fcc";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="Mr言的博客" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://res.cloudinary.com/bravey/image/upload/v1588158174/avatar3.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">10</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">6</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关系</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#abstract"><span class="toc-number">1.</span> <span class="toc-text"> abstract</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#introduction"><span class="toc-number">2.</span> <span class="toc-text"> Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="toc-number">3.</span> <span class="toc-text"> 复制状态机</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#paxos%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">4.</span> <span class="toc-text"> Paxos的缺点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%90%86%E8%A7%A3%E6%80%A7%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.</span> <span class="toc-text"> 理解性设计</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#raft%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95"><span class="toc-number">6.</span> <span class="toc-text"> Raft一致性算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#raft-basics"><span class="toc-number">6.1.</span> <span class="toc-text"> raft basics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#leader-elction"><span class="toc-number">6.2.</span> <span class="toc-text"> Leader elction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#log-replication"><span class="toc-number">6.3.</span> <span class="toc-text"> Log replication</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#safety"><span class="toc-number">6.4.</span> <span class="toc-text"> Safety</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#election-restriction"><span class="toc-number">6.4.1.</span> <span class="toc-text"> Election restriction</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#committing-entries-from-previous-terms"><span class="toc-number">6.4.1.1.</span> <span class="toc-text"> Committing entries from previous terms</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/fx9Gcq.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Mr言的博客</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关系</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">In Search of an Understandable Consensus Algorithm(Extended Version)</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2021-09-02 16:09:24"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2021-09-02</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-11-04 09:45:14"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-11-04</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">分布式系统</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="abstract"><a class="markdownIt-Anchor" href="#abstract"></a> abstract</h1>
<p>raft是一个管理分布日志的一致性算法，运行结果和Paxos一致，但是结构并不一样，因此Raft比Paxos更易懂，也为构建系统提供了更好的基础。为了更好理解，Raft将一致性的关键点分开，比如领导选取，日志备份，安全性。通过减少了状态数量加强了一致性的强度。</p>
<h1 id="introduction"><a class="markdownIt-Anchor" href="#introduction"></a> Introduction</h1>
<p>Raft的目的是<strong>可理解性</strong>。因此将关键元素进行解偶。相关特性</p>
<ol>
<li>Strong leader：Raft提供了一个比别的算法更强劲的leader。比如日志条目仅仅从leader到其他的server，使得Raft更好管理备份日志</li>
<li>Leader elction：Raft用一个随机的定时器来选举leader。这仅仅在其他算法的心跳机制上添加少量机制即可</li>
<li>Membership changes：使用一个联合一致方法，使得在配置改变时，集群仍然可以工作</li>
</ol>
<p>文章结构：</p>
<ol>
<li>section2：复制状态机问题</li>
<li>section3：讨论优点和缺点</li>
<li>section4：理解性设计</li>
<li>Section5-8：表示Raft，评估Raft</li>
<li>Section10：讨论相关工作</li>
</ol>
<h1 id="复制状态机"><a class="markdownIt-Anchor" href="#复制状态机"></a> 复制状态机</h1>
<p>一致性算法通常出现在复制状态机中 。在这个算法中，一系列状态机可以计算相同状态的相同副本，即使有几个服务器宕机，也可以继续执行。</p>
<p>复制状态机通常通过复制日志来实现，如图</p>
<p><img src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/3tBFjF.png" alt="" /></p>
<p>每个server存储一系列命令，其状态机按序执行命令。因为每个日志的命令都相同，因此每个状态机按照相同的循序执行命令。</p>
<p>一致性算法需要持久化备份日志。</p>
<p>一致性模块从client接受命令，然后添加到日志中。一致性模块会和其他server的一致性模块沟通，确保每个日志 最终一致，即使有一些server失败。</p>
<p>一致性模块有如下特点</p>
<ol>
<li>保证安全性，永远不会返回错误的结果</li>
<li>只要大多数服务器都是可操作的，并且可以与其他服务器和客户端通信，它们都是完全可用的</li>
<li>不依靠定时来保证一致</li>
<li>在一般情况下，只要集群的大多数成员响应了一轮远程过程调用，命令就可以完成;少数速度较慢的服务器不需要影响整个系统的性能</li>
</ol>
<h1 id="paxos的缺点"><a class="markdownIt-Anchor" href="#paxos的缺点"></a> Paxos的缺点</h1>
<p>Paxos最开始定义了协议，改协议能够就单个决策达成协议，我们称之为单一法令Paxos。</p>
<p>后来结合了多个实例，可以完成了一系列决策，比如日志。paxos保证了安全性和可用性，并且支持集群中成员的改变，其正确性已经在多个案例被证实</p>
<p>但是Paxos有两个很大的缺点：</p>
<ol>
<li>难以理解，不透明性
<ol>
<li>来源于单一法令paxos的基础。</li>
</ol>
</li>
<li>没有为搭建系统系统良好的基础
<ol>
<li>没有广泛认可的算法</li>
<li>理论和现实相差太远</li>
</ol>
</li>
</ol>
<h1 id="理解性设计"><a class="markdownIt-Anchor" href="#理解性设计"></a> 理解性设计</h1>
<p><strong>目标：</strong></p>
<ol>
<li>为系统搭建提供完整的，有实际意义的基础</li>
<li>必须安全</li>
<li>理解性
<ol>
<li>将leader选举，日志复制，安全，成员改变进行解偶</li>
<li>减少状态空间，从而使得系统更全面和 减少其确定性，特别是，Raft不允许日志和其他日志不相同。</li>
<li>通过随机方法来简化leader选举</li>
</ol>
</li>
</ol>
<h1 id="raft一致性算法"><a class="markdownIt-Anchor" href="#raft一致性算法"></a> Raft一致性算法</h1>
<p><img src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/vqLXzZ.png" alt="" /></p>
<p><img src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/82RZPc.png" alt="" /></p>
<p>Raft最开始选举一个leader，然后给leadre完整权限来管理备份日志。leader从client接受log条目，然后备份到其他server，并且其他server告诉leader何时可以安全执行日志条目到状态机上。leader简化了备份日志的管理。当leader可以决定将新条目放在何处，而不需要咨询其他server，保持一种leader到其他server到数据流。leader如果失败或者和其他server失去联系，则重新选举leader。</p>
<p>对了leader策略，raft将一致性问题解偶成三个相对独立的子问题。</p>
<ol>
<li>leader election：当现有的leader失败时，需要重新选举一个leader</li>
<li>log replication：leader接受来自client的日志条目，并且将它们备份到集群，强迫其他日志与自己保持一致</li>
<li>safety：安全特点如图3。如果任意server在状态机中执行了一个log条目，其他server就不能对相同索引条目执行不同的命令。</li>
</ol>
<h2 id="raft-basics"><a class="markdownIt-Anchor" href="#raft-basics"></a> raft basics</h2>
<p>raft集群包括好几个server，5个是最通用的数据，允许系统出现两次错误。在任何给定时间，每个server都只会处于三个状态中：leader，follower，candidate。</p>
<p>在正常操作下，只会有一个leader，其他所有server都是follower。follower是被动的，他们不可发出任何request，只能响应来自leader和candidate的request。leader处理client request(如果client和follower连接，follower会直接重定向给leader)。candidate用来选举新的leader。三者转换如图4</p>
<p><img src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/90dbfJ.png" alt="" /></p>
<p>raft将时间分为任意长度的terms，如图5</p>
<p><img src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/kcubEk.png" alt="" /></p>
<p>terms是连续正数。每个term以leader选举开始，其中一个或多个candidate试图成为leader。如果candidate赢得选举，会作为rest余下时间的leader。在某些情况下，选择的结果是投票一样，此时该term没有leader，新的term会开始，raft保证在给定term至多有一个leader。</p>
<p>不同的server可能看到不同的转换，在相同情况下，server不会在整个term都不会观察到选举。</p>
<p>term作为raft的一个逻辑时间，允许server去检测过期的信息，比如过期的leader。每个server都存储一个current term数字，并且之后单调递增。current term在server交互时交换，如果server的current term小于其他server的current term，则更新他的current term。如果candidate或者leader发现他的current term更小，则立即转为follower，如果一个server接收到一个比较老的term的请求，则拒绝该请求。</p>
<p>Raft server使用rpc来沟通，基础的一致性算法仅仅要求两个RPC，RequestVode RPC在选举阶段被candidate初始化，AppendEntries RPC由leader初始化来备份log条目，并且提供心跳检测。server会重发rpc如果在时间段内没有收到回应。</p>
<h2 id="leader-elction"><a class="markdownIt-Anchor" href="#leader-elction"></a> Leader elction</h2>
<p>Raft使用心跳检测机制来触发leader 选举。当server开始，所有人都是follower。server如果接受有效的来自leader和candidate的rpc，则一直保持follower。leader会定期发送心跳检测（APpendEntries RPC，不携带log条目）给所有follower从而维护权威。如果follower在一定时间election timeout没有收到candidate和leader的沟通，则默认没有leader，并且开始选举一个leader。</p>
<p>在选举初期，follower增加其current term，并且转换成candidate。然后投票给自己，并且发送requestvode rpc给集群中的其他server。server一直保护candidate，直到</p>
<ol>
<li>赢得选举</li>
<li>其他的server当选leader</li>
<li>一段时间没有winner</li>
</ol>
<p>如果candidate在同一term中获得过半票数，则赢得选举。每个server最多投给一个candidate，并且遵守FIFO原则。大多数规则保证最多一个candidate赢得选举(图3的election safety)。一旦candidate赢得选举，成为leader，则发送心跳检测给所有server来建立权威，避免其他的选举。</p>
<p>在等待投票阶段，candidate可能收到其他leader发来的aendEntries rpc。如果leader的current term至少和candidate的cuttenr term一样大，candidate承认leader，然后转为follower。如果rpc的term小于candidate，则拒绝，继续当candidate。</p>
<p>第三种可能性是candidate既没有赢，也没有输。如果多个follower同一时间成为candidate，投票可能一致，没有人赢得选举。发生时，candidate会超时，并且通过增加term，初始化request RPC开始新一轮的选举，然而，如果不采取其他操作，投票一直可能一直存在。</p>
<p>raft使用随机election timeout来保证投票一直不会经常出现，并且会很快得到解决。为了避免出现，election timeouts会随机取150-300ms的值。这会分散服务器，因此在大多数情况下，只有一台服务器会超时。在其他服务器超时之前赢得选举，并且发送心跳检测。每个candidate在选举初期重新随机election timeout，超时后重新开始一轮选举，这样会减少投票一致的可能性。</p>
<p><img src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/NqXVtW.png" alt="" /></p>
<p>选举就是一个例子，说明可理解性如何引导我们在设计选择中做出选择。最初我们选择用排名系统，每个candidate被分配一个独有的排名，用来竞争。如果candidate发现另一个candidate的排名更高，则转为follower，所以更高排名的candidate更容易赢得选举。但该策略会产生小问题，如果高排名的server失败，低排名的server可能会超时，成为candidate，但是这么做过于频繁，会导致进程重新进入leader选举。</p>
<h2 id="log-replication"><a class="markdownIt-Anchor" href="#log-replication"></a> Log replication</h2>
<p>一旦选举好leader，则开始服务client request。每次client request包含一个需要状态机执行的命令。leader会将命令作为一个log条目添加，然后发出一个appendentries rpc给其他server来完成备份。当log条目被安全备份，leader会在状态机中执行该条目，返回结果给client。如果follower崩溃或者运行缓慢，或者网络丢包，leader会再次发送appendentries rpc，直到所有的follower都存储所有的log条目。</p>
<p><img src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/gHJCDM.png" alt="" /></p>
<p>log如图6.每个log条目存储一个状态机需要执行的命令和leader接受条目所处term。日志中的term用来去发现日志间的不一致性，保证图3的其他特性。每个log条目有都有一个日志的索引。</p>
<p>leader来决定什么时候将命令交给状态机去执行，这样的log条目成为commited。Raft保证commmit条目持久化，并且最终一定会被所有可用的状态机所执行。一旦创建log条目的leader发现在绝大多数server上备份，就会commit log日志。如图6的entry 7(三个server都备份了)。还会commit leader之前的所有log条目，包括之前leader创建的。Leader会跟踪所comimt的log条目的最高索引，并且在未来的appendentri rpc中会包含该索引，以至于其他的server最终可以发现最高索引。一旦follower知道一个log条目被commited，则会在状态机中执行该条目。</p>
<p>设计Raft log机制是为了保持不同server的高水平一致性。不仅仅是为了简化系统的行为，并且更加可预测，同时可以保证安全。Raft维持如下特性，这些特性构成了图3的Log Matching Property.</p>
<ol>
<li>如果在不同的日志中，两个条目有相同的term和index，则他们一定存储一样的命令</li>
<li>如果在不同的日志中，有相同的index和term，则之前的所有条目都是相同的。</li>
</ol>
<p>第一个特点基于这么一个事实：在给定一个term和index中，leader最多创建一个条目，log条目在日志的位置永远不会改变。第二个特性由AppendEntries的简单一致性检查保证。当发送一个appendentries rpc时，leader会给出最接近最新条目条目的tern和index。如果follower在日志中和发现没有该条目，则会拒绝新条目。</p>
<p>一致性检查有一个归纳步骤：最开始日志为空，满足Log Matching Property，当日志扩展时，一致性检查仍满足改特定，因此，无论何时appendEntries总是成功满足。</p>
<p>正常操作下，leader和follower的日志总是保持一致，所以appendentries一致性检查不会失败。然而，leader崩溃可能导致日志不一致（老的leader可能没有完全备份log条目）。不一致性可能有一系列leader和follower的崩溃导致。</p>
<p><img src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/ENMFSt.png" alt="" /></p>
<p>图7现实，follower的日志可能和leader日志不同。follower可能丢失leader的日志，可能有leader没有的日志，或者两者皆有，并且日志中的条目可能跨越多个term。</p>
<p>在raft中，leader通过强迫follower丢弃log条目来满足一致性。这意味着follower日志中冲突的条目会被重写。</p>
<p>为了保证follower的日志和自己的日志一致，leader必须知道两者之间最接近的条目，然后删除该条目之后的条目，然后再发给follower leader之后的条目。这些操作都是由响应appendentries rpc来保证的。</p>
<p>leader对每个server维持一个nextindex，表示需要发给follower下一个条目的index。当leader第一次掌权，会初始化nextIndex为最后一个值的索引(图7的11)。如果folloer日志和leader不一致，appendentries一致性检查会在下一次appendentries rpc中失败。遭到拒绝后，leader会减少nextindex的值，然后重试。最终nextindex会到达leader和follower都满足的一个点。当到达该店后，appendentries会成功，然后会丢弃follower该点之后的log条目，然后添加leader该点之后的log条目。一旦appendentries成功，follower日志会和leader日志保持一致。</p>
<p>如果可能，算法还可以优化，来减少rpc的拒绝次数。比如，当拒绝一个appendtries请求时，follower会给出冲突条目的term和第一个存储该term的index。通过该信息，leader可以减少下一次传递给follower日志的nextindex。对于有冲突term的条目，只需要一个rpc，而不是一个index就需要一个rpc。在实践中，该优化很有必要，因为错误会经常失败，可能会出现多次不一致条目。</p>
<p>通过该机制，leader不需要去采用别的举措来重新构造日志一致性。仅仅是正常操作，日志会为了响应appendentries的一致性检查而自然汇聚。leader永远不需要重写或者删除自己的条目（图3的Leader Append-Only特性）。</p>
<p>该日志备份机制展示了合适的一致性特点，raft可以接受，备份，执行日志条目，只要大部分server可以运行。正常情况下，一个新的条目会在一轮rpc备份到其他server中，单个较慢的follower并不会影响性能。</p>
<h2 id="safety"><a class="markdownIt-Anchor" href="#safety"></a> Safety</h2>
<h3 id="election-restriction"><a class="markdownIt-Anchor" href="#election-restriction"></a> Election restriction</h3>
<p>leader必须最终存储所有的commited log条目。Raft保证之前term所commit的log条目一定会出现在每个新的leader上，不需要传输这些条目给leader。因为raft中的log条目只能从leader到follower，leader永远不需要重写已存在的日志条目。</p>
<p>Raft使用投票来防止candidate赢得选举，除非他的日志包含了所有的commited条目。一个candidate必须和集群中的大多数server交互来赢得选举，意味着每个commited条目至少存在于一个server中。如果candidate的日志和大多数server的日志一样新，表示他表示了所有已经commited条目。requestVore RPC添加以下限制：<strong>rpc包括了candidate的日志，如果选举人的日志比候选人的日志新，则不投票。</strong></p>
<p>raft通过比较最后一个条目的index和term来比较哪个日志更新。如果最有一个条目有不同的term，term越大越新，如果term一致，index越大越新。</p>
<h4 id="committing-entries-from-previous-terms"><a class="markdownIt-Anchor" href="#committing-entries-from-previous-terms"></a> Committing entries from previous terms</h4>
<p>一旦log条目被多个server备份，则将该条目commit。如果leader再commit条目之前崩溃，未来的leader会试图完成条目的备份。然而，即使一个条目存储在多个srever中，leader也不能立即判断是否可以commit。</p>
<p><img src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/r71mNO.png" alt="" /></p>
<p>图8现实了如果旧的log日志存储在多个server中，仍然会被未来的leader所覆写。</p>
<p>为了解决图8的问题，raft不会通过计数来提交之前term的log条目。只通过计数来计算来commitcurrent term之前的log条目。一旦current term的日志commit，所有之前的log条目也会被提交。（也就是说只有current term的条目被多次备份，才会提交current tern前面的log条目）</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">严轶轩</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.mryan.cool/2021/09/02/In-Search-of-an-Understandable-Consensus-Algorithm-Extended-Version/">https://www.mryan.cool/2021/09/02/In-Search-of-an-Understandable-Consensus-Algorithm-Extended-Version/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.mryan.cool" target="_blank">Mr言的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">分布式系统</a><a class="post-meta__tags" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">文件系统</a></div><div class="post_share"><div class="social-share" data-image="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/o3yatk.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2021/10/14/python%E4%BE%9D%E8%B5%96%E6%A0%91-pipdeptree/"><img class="prev_cover" src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/frp7ZH.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">python依赖树--pipdeptree</div></div></a></div><div class="next-post pull_right"><a href="/2021/08/18/The-Google-File-System/"><img class="next_cover" src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/dZ4ECE.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">The Google File System</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021/08/18/The-Google-File-System/" title="The Google File System"><img class="relatedPosts_cover" src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/dZ4ECE.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-08-18</div><div class="relatedPosts_title">The Google File System</div></div></a></div><div class="relatedPosts_item"><a href="/2021/11/02/ZooKeeper-wait-free-coordination-for-Internet-scale-systems/" title="ZooKeeper-wait-free-coordination-for-Internet-scale-systems"><img class="relatedPosts_cover" src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/o3yatk.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-11-02</div><div class="relatedPosts_title">ZooKeeper-wait-free-coordination-for-Internet-scale-systems</div></div></a></div><div class="relatedPosts_item"><a href="/2021/08/14/MapReduce-Simplified-Data-Processing-On-Large-Clusters/" title="MapReduce:Simplified Data Processing On Large Clusters"><img class="relatedPosts_cover" src="https://mryanhehe-1300112970.cos.ap-chengdu.myqcloud.com/uPic/j03zGh.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-08-14</div><div class="relatedPosts_title">MapReduce:Simplified Data Processing On Large Clusters</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 严轶轩</div><div class="framework-info"><span>驱动 </span><a target="_blank" rel="noopener" href="https://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a><span class="footer-separator">|</span><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/"><span>鄂ICP备20008765号-1</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script></body></html>